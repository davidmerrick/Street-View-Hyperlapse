Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.toDeg=function(){return this*180/Math.PI};Array.prototype.remove=function(e,t){var n=this.slice((t||e)+1||this.length);this.length=e<0?this.length+e:e;return this.push.apply(this,n)};var pointOnLine=function(e,t,n){var r=t.lat().toRad(),i=t.lng().toRad();var s=n.lat().toRad(),o=n.lng().toRad();x=r+e*(s-r);y=i+e*(o-i);return new google.maps.LatLng(x.toDeg(),y.toDeg())};var HyperlapsePoint=function(e,t,n){var r=this;var n=n||{};this.location=e;this.pano_id=t;this.heading=n.heading||0;this.pitch=n.pitch||0;this.elevation=n.elevation||0;this.image=n.image||null;this.copyright=n.copyright||"Â© 2013 Google";this.image_date=n.image_date||""};var Hyperlapse=function(e,t){"use strict";var n=this,r=[],i=e,s=t||{},o=s.width||800,u=s.height||400,a=20,f=s.use_elevation||false,l=s.distance_between_points||5,c=s.max_points||100,h=s.fov||70,p=s.zoom||1,d=0,v=0,m=0,g=0,y=false,b=false,w=0,E=0,S=0,x=true,T=0,N=0,C,k,L,A,O,M,_,D=false,P=Date.now(),H=0,B=0,j=null,F=[],I=[];var q=function(e){if(n.onError)n.onError(e)};var R=function(e){if(n.onFrame)n.onFrame(e)};var U=function(e){if(n.onPlay)n.onPlay(e)};var z=function(e){if(n.onPause)n.onPause(e)};var W=new google.maps.ElevationService;var X=new google.maps.StreetViewService;C=document.createElement("canvas");k=C.getContext("2d");L=new THREE.PerspectiveCamera(h,o/u,1,1100);L.target=new THREE.Vector3(0,0,0);A=new THREE.Scene;A.add(L);try{var V=!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch($){console.log($)}O=new THREE.WebGLRenderer;O.autoClearColor=false;O.setSize(o,u);M=new THREE.Mesh(new THREE.SphereGeometry(500,60,40),new THREE.MeshBasicMaterial({map:new THREE.Texture,side:THREE.DoubleSide}));A.add(M);i.appendChild(O.domElement);_=new GSVPANO.PanoLoader({zoom:p});_.onError=function(e){q({message:e})};_.onPanoramaLoad=function(){var e=document.createElement("canvas");var t=e.getContext("2d");e.setAttribute("width",this.canvas.width);e.setAttribute("height",this.canvas.height);t.drawImage(this.canvas,0,0);I[w].image=e;if(++w!=I.length){K({position:w});if(!D){_.composePanorama(I[w].pano_id)}else{J({})}}else{Q({})}};var J=function(e){D=false;b=false;if(n.onLoadCanceled)n.onLoadCanceled(e)};var K=function(e){if(n.onLoadProgress)n.onLoadProgress(e)};var Q=function(e){b=false;w=0;it();if(n.onLoadComplete)n.onLoadComplete(e)};var G=function(e){if(n.onRouteProgress)n.onRouteProgress(e)};var Y=function(e){var t=[];for(var r=0;r<I.length;r++){t[r]=I[r].location}if(f){et(t,function(t){if(t){for(r=0;r<I.length;r++){I[r].elevation=t[r].elevation}}else{for(r=0;r<I.length;r++){I[r].elevation=-1}}n.setLookat(n.lookat,true,function(){if(n.onRouteComplete)n.onRouteComplete(e)})})}else{for(r=0;r<I.length;r++){I[r].elevation=-1}n.setLookat(n.lookat,false,function(){if(n.onRouteComplete)n.onRouteComplete(e)})}};var Z=function(e){_.load(F[w],function(){if(_.id!=j){j=_.id;var t=new HyperlapsePoint(_.location,_.id,{heading:_.rotation,pitch:_.pitch,elevation:_.elevation,copyright:_.copyright,image_date:_.image_date});I.push(t);G({point:t});if(w==F.length-1){Y({response:e,points:I})}else{w++;if(!D)Z(e);else J({})}}else{F.splice(w,1);if(w==F.length){Y({response:e,points:I})}else{if(!D)Z(e);else J({})}}})};var et=function(e,t){var n={locations:e};W.getElevationForLocations(n,function(e,n){if(n==google.maps.ElevationStatus.OK){t(e)}else{if(n==google.maps.ElevationStatus.OVER_QUERY_LIMIT){console.log("Over elevation query limit.")}f=false;t(null)}})};var tt=function(e){if(!y){var t=e.routes[0];var r=t.overview_path;var i=t.legs;var s=0;for(var o=0;o<i.length;++o){s+=i[o].distance.value}var u=s/c;a=u<l?a=l:a=u;var f=0;var h=0;var p,d;for(o=0;o<r.length;o++){if(o+1<r.length){p=r[o];d=r[o+1];f=google.maps.geometry.spherical.computeDistanceBetween(p,d);if(h>0&&h<f){p=pointOnLine(h/f,p,d);f=google.maps.geometry.spherical.computeDistanceBetween(p,d);F.push(p);h=0}else if(h>0&&h>f){h-=f}if(h===0){var v=Math.floor(f/a);if(v>0){for(var m=0;m<v;m++){var g=m/v;if(g>0||g+o===0){var b=pointOnLine(g,p,d);F.push(b)}}h=f-a*v}else{h=a*(1-f/a)}}}else{F.push(r[o])}}Z(e)}else{n.pause();tt(e)}};var nt=function(){M.material.map.image=I[w].image;M.material.map.needsUpdate=true;E=I[w].heading;S=I[w].pitch;if(n.use_lookat)T=google.maps.geometry.spherical.computeHeading(I[w].location,n.lookat);if(I[w].elevation!=-1){var e=I[w].elevation-n.elevation_offset;var t=google.maps.geometry.spherical.computeDistanceBetween(I[w].location,n.lookat);var r=N-e;var i=Math.atan(Math.abs(r)/t).toDeg();g=r<0?-i:i}R({position:w,point:I[w]})};var rt=function(){if(!b&&n.length()>0){var e=w/n.length();var t=n.position.x+n.offset.x*e;var r=n.position.y+n.offset.y*e;var i=n.tilt+n.offset.z.toRad()*e;var s=n.use_lookat?T-E.toDeg()+t:t;var o=g+r;var u=v,a=d;v=v+(s-u);d=d+(o-a);d=Math.max(-85,Math.min(85,d));var f=(90-d).toRad();var l=v.toRad();L.target.x=500*Math.sin(f)*Math.cos(l);L.target.y=500*Math.cos(f);L.target.z=500*Math.sin(f)*Math.sin(l);L.lookAt(L.target);L.rotation.z-=i;if(n.use_rotation_comp){L.rotation.z-=n.rotation_comp.toRad()}M.rotation.z=S.toRad();O.render(A,L)}};var it=function(){var e=P;P=Date.now();B+=P-e;if(B>=n.millis){if(y)st();B=0}requestAnimationFrame(it);rt()};var st=function(){nt();if(x){if(++w==I.length){w=I.length-1;x=!x}}else{if(--w==-1){w=0;x=!x}}};this.lookat=s.lookat||null;this.millis=s.millis||50;this.elevation_offset=s.elevation||0;this.tilt=s.tilt||0;this.position={x:0,y:0};this.offset={x:0,y:0,z:0};this.use_lookat=s.use_lookat||false;this.use_rotation_comp=false;this.rotation_comp=0;this.isPlaying=function(){return y};this.isLoading=function(){return b};this.length=function(){return I.length};this.setPitch=function(e){g=e};this.setDistanceBetweenPoint=function(e){l=e};this.setMaxPoints=function(e){c=e};this.fov=function(){return h};this.webgl=function(){return O};this.getCurrentImage=function(){return I[w].image};this.getCurrentPoint=function(){return I[w]};this.setLookat=function(e,t,r){n.lookat=e;if(f&&t){var i=et([n.lookat],function(e){if(e){N=e[0].elevation}else{}if(r&&r.apply)r()})}else{if(r&&r.apply)r()}};this.setFOV=function(e){h=Math.floor(e);L.projectionMatrix.makePerspective(h,o/u,1,1100)};this.setSize=function(e,t){o=e;u=t;O.setSize(o,u);L.projectionMatrix.makePerspective(h,o/u,1,1100)};this.reset=function(){F.remove(0,-1);I.remove(0,-1);n.tilt=0;d=0;v=0;n.position.x=0;n.offset.x=0;n.offset.y=0;n.offset.z=0;m=0;g=0;w=0;E=0;S=0;x=true};this.generate=function(e){if(!b){b=true;n.reset();var t=e||{};l=t.distance_between_points||l;c=t.max_points||c;if(t.route){tt(t.route)}else{console.log("No route provided.")}}};this.load=function(){w=0;_.composePanorama(I[w].pano_id)};this.cancel=function(){if(b){D=true}};this.getCameraPosition=function(){return new google.maps.LatLng(d,v)};this.play=function(){if(!b){y=true;U({})}};this.pause=function(){y=false;z({})};this.next=function(){n.pause();if(w+1!=I.length){w++;nt()}};this.prev=function(){n.pause();if(w-1!==0){w--;nt()}}}